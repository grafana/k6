k6 v0.48.0 is here ðŸŽ‰! This release includes:

- (_optional_) `<highlight of breaking changes>`
- `<Summary of new features>` (_one or multiple bullets_)

## Breaking changes

- [#3350](https://github.com/grafana/k6/pull/3350) In k6 [v0.37](https://github.com/grafana/k6/releases/tag/v0.37.0), we deprecated a gRPC Invoke's parameter `headers`. This release removes the parameter. If you need to set headers, use a `metadata` parameter instead.
- [#3448](https://github.com/grafana/k6/pull/3448) metric names now need to conform to both otel and prometheus name requirements while still being limitted to 128 characters (old k6 limit).
- [#3451](https://github.com/grafana/k6/pull/3451) In k6 [v0.25](https://github.com/grafana/k6/releases/tag/v0.25.0) module specifiers were allowed to be urls with scheme, and k6 prepending `https://` to anything that it wasn't recognizing was deprecated. From this version k6 will no longer try to do that all, please use full URLs if you want to load remote modules.

### Redis (m)TLS support and new Client constructor options [`xk6-redis/#17`](https://github.com/grafana/xk6-redis/pull/17)

In this release, the `k6/experimental/redis`` module receives several important changes, including breaking updates.

#### Connection URLs

The `Client` constructor now supports connection URLs to configure connections to Redis servers or clusters. These URLs can be in the format `redis://[[username][:password]@][host][:port][/db-number]` for standard connections, or `rediss://[[username][]:password@]][host][:port][/db-number]` for TLS-secured connections. For more details, see the [documentation](https://grafana.com/docs/k6/latest/javascript-api/k6-experimental/redis/).

##### Example usage

```javascript
import redis from 'k6/experimental/redis';

const redisClient = new redis.Client('redis://someusername:somepassword@localhost:6379/0');
```

#### Revamped Options object

The `Client` constructor has been updated with a new [Options](https://grafana.com/docs/k6/latest/javascript-api/k6-experimental/redis/redis-options/) object format. This change aligns the module with familiar patterns from NodeJS and Deno libraries, offering enhanced flexibility and control over Redis connections. Detailed information is available in the [documentation](https://grafana.com/docs/k6/latest/javascript-api/k6-experimental/redis/redis-options/).

##### Example usage

```javascript
import redis from 'k6/experimental/redis';

const redisClient = new redis.Client({
  socket: {
    host: 'localhost',
    port: 6379,
  },
  username: 'someusername',
  password: 'somepassword',
});
```

#### (m)TLS support

The module now includes (m)TLS support, enhancing security for connections. This update also improves support for Redis clusters and sentinel modes (failover). For connections using self-signed certificates, enable k6's [insecureSkipTLSVerify](https://grafana.com/docs/k6/latest/using-k6/k6-options/reference/#insecure-skip-tls-verify) option (set to `true`).

##### Example usage
```javascript
import redis from 'k6/experimental/redis';

const redisClient = new redis.Client({
  socket: {
    host: 'localhost',
    port: 6379,
    tls: {
      ca: [open('ca.crt')],
      cert: open('client.crt'), // client certificate
      key: open('client.key'), // client private key
    },
  },
});
```

## New features

### Add `k6 new` subcommand [#3394](https://github.com/grafana/k6/pull/3394)

`k6` now has a `new` subcommand that can be used to generate a new test script. This is useful for new users who want to get started quickly, or for experienced users who want to save time when creating new test scripts. The subcommand can be used like this:

```bash
k6 new [filename]
```

If no filename is provided, the default filename `script.js` will be used. The subcommand will create a new file with the provided name in the current directory, and populate it with a basic test script that can be run with `k6 run`.

### Add a `k6/experimental/fs` module [#3165](https://github.com/grafana/k6/pull/3165)

`k6` now has a new `k6/experimenal/fs` module providing a memory-efficient way to handle file interactions within your test scripts. It currently offers support for opening files, reading their content, and seeking through their content, and retrieving metadata about them.

Unlike the traditional [open](https://grafana.com/docs/k6/latest/javascript-api/init-context/open/) function, which loads a file multiple times into memory, the filesystem module reduces memory usage by loading the file as little possible, and sharing the same memory space between all VUs. This approach signally reduces the memory footprint of your test script, and lets you load and process large files without running out of memory.

For more information, see to the [documentation of the module](https://grafana.com/docs/k6/latest/javascript-api/k6-experimental/fs/).

##### Example usage

```javascript
import fs from 'k6/experimental/fs';

// k6 doesn't support async in the init context. We use a top-level async function for `await`.
//
// Each Virtual User gets its own `file` copy.
// So, operations like `seek` or `read` won't impact other VUs.
let file;
(async function () {
  file = await open('bonjour.txt');
})();

export default async function () {
  // About information about the file
  const fileinfo = await file.stat();
  if (fileinfo.name != 'bonjour.txt') {
    throw new Error('Unexpected file name');
  }

  const buffer = new Uint8Array(128);

  let totalBytesRead = 0;
  while (true) {
    // Read into the buffer
    const bytesRead = await file.read(buffer);
    if (bytesRead == null) {
      // EOF
      break;
    }

    // Do something useful with the content of the buffer
    totalBytesRead += bytesRead;

    // If bytesRead is less than the buffer size, we've read the whole file
    if (bytesRead < buffer.byteLength) {
      break;
    }
  }

  // Check that we read the expected number of bytes
  if (totalBytesRead != fileinfo.size) {
    throw new Error('Unexpected number of bytes read');
  }

  // Seek back to the beginning of the file
  await file.seek(0, SeekMode.Start);
}
```

### Add support for browser module's `page.throttleCPU` [browser#1095](https://github.com/grafana/xk6-browser/pull/1095)

Allows users to throttle the CPU from chrome/chromium's perspective, which helps emulate slower devices when testing the website's frontend. The mandatory argument is of type `CPUProfile`, which is made up of one field named `rate` that is a slow down factor, where `1` means no throttling, and `2` means 2x slowdown, and so on. The documentation for this API can be found [here](https://grafana.com/docs/k6/v0.48.x/javascript-api/k6-experimental/browser/page/throttlecpu).

```js
...
  const context = browser.newContext();
  const page = context.newPage();

  try {
    page.throttleCPU({ rate: 4 });
...
```

### Add support for browser module's `page.throttleNetwork` [browser#1094](https://github.com/grafana/xk6-browser/pull/1094)

Allows users to throttle the characteristics of the network from chrome/chromium's perspective, which helps emulate poor network connections when testing the website's frontend. The mandatory argument is of type `NetworkProfile` and is defined as:

```ts
export interface NetworkProfile {
    /*
     * Minimum latency from request sent to response headers received (ms).
     */
    latency: number;
    
    /*
     * Maximal aggregated download throughput (bytes/sec). -1 disables download
     * throttling.
     */
    download: number;
    
    /*
     * Maximal aggregated upload throughput (bytes/sec). -1 disables upload
     * throttling.
     */
    upload: number;
}
```

You can either define your own network profiles or use the ones we have defined by importing `networkProfiles` from the `browser` module. The documentation for this API can be found [here](https://grafana.com/docs/k6/v0.48.x/javascript-api/k6-experimental/browser/page/throttlenetwork).

```js
import { browser, networkProfiles } from 'k6/experimental/browser';
...
  const context = browser.newContext();
  const page = context.newPage();

  try {
    page.throttleNetwork(networkProfiles['Slow 3G']);
...
```

## UX improvements and enhancements

- [browser#1074](https://github.com/grafana/xk6-browser/pull/1074) Adds a new `browser.closeContext()` [method](https://k6.io/docs/javascript-api/k6-experimental/browser/closecontext/) to facilitate closing the current active browser context.
- [#3370](https://github.com/grafana/k6/pull/3370). The k6 got a new flag `--profiling-enabled` which enables exposing [pprof](https://go.dev/blog/pprof) profiling endpoints. The profiling endpoints are exposed on the same port as the HTTP REST API under the `/debug/pprof/` path. This could be useful for the extension developers.
- [#3442](https://github.com/grafana/k6/pull/3442). The k6 now supports a new `--version` flag. It has the same output as `k6 version` command. Thanks, @ffapitalle!
- [#3423](https://github.com/grafana/k6/pull/3423). The InfluxDB output got an environment variable `K6_INFLUXDB_PROXY` which allows specifying proxy. Thanks, @IvanovOleg!

## Bug fixes

- [#3380](https://github.com/grafana/k6/pull/3380) Output message to the `--console-output` file at the same level as it would to stdout. This makes `-v` work in the same way for both.
- [#3416](https://github.com/grafana/k6/pull/3416) Prints the stack trace when there's an exception in `handleSummary()`.
- [#3438](https://github.com/grafana/k6/pull/3438) Don't error on http requests with content-encoding and http statuses known for having no body.
- [browser#1077](https://github.com/grafana/xk6-browser/pull/1077) Fixes `browserContext.clearPermissions` to clear permissions without panic.
- [browser#1042](https://github.com/grafana/xk6-browser/pull/1042) Fixes `browserContext.waitForEvent` which involved promisifying the `waitForEvent` API.
- [browser#1078](https://github.com/grafana/xk6-browser/pull/1078) Fixes request interception deadlock to improve stability.

## Maintenance and internal improvements

- [#3378](https://github.com/grafana/k6/pull/3378) Fix usage of `gh` in GitHub actions creating the OSS release.
- [#3386](https://github.com/grafana/k6/pull/3386), [#3387](https://github.com/grafana/k6/pull/3387), [#3388](https://github.com/grafana/k6/pull/3388) k6 dependencies updates.
- [#3393](https://github.com/grafana/k6/pull/3393) Fix lint issues in the `js` package.
- [#3397](https://github.com/grafana/k6/pull/3397) The `goja` dependency update. Fixed a possible panic at `JSON.stringify`.
- [#3381](https://github.com/grafana/k6/pull/3381) We temporarily disabled ARM tests on GitHub Actions.
- [#3401](https://github.com/grafana/k6/pull/3401) A Makefile refactoring, `make ci-like-lint` was removed in favor of `make lint`. The golangci-lint version updated to v1.54.2.
- [#3410](https://github.com/grafana/k6/pull/3410) Fixed the `tests` reference in the all rule of the Makefile. Thanks, @flyck!
- [#3402](https://github.com/grafana/k6/pull/3402) Additional test-case for the `k6 cloud`.
- [#3421](https://github.com/grafana/k6/pull/3421) Update dependencies for xk6 integration tests.
- [browser#1075](https://github.com/grafana/xk6-browser/pull/1075), [browser#1076](https://github.com/grafana/xk6-browser/pull/1076) Refactors `clearPermissions` and `grantPermissions`.
- [browser#1043](https://github.com/grafana/xk6-browser/pull/1043) Refine tests.
- [browser#1047](https://github.com/grafana/xk6-browser/pull/1047) Update dependencies.
- [browser#1069](https://github.com/grafana/xk6-browser/pull/1069), [browser#1090](https://github.com/grafana/xk6-browser/pull/1090) Internal refactors.
- [#3443](https://github.com/grafana/k6/pull/3443). We explicitly mentioned that we aim to support the last two major golang versions for building a k6 binary.

## _Optional_ Roadmap

_Discussion of future plans_

