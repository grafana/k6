k6 1.5.0 is here ðŸŽ‰! This release includes significant enhancements to the browser module, improved debugging capabilities, new extension APIs, and a revamped machine-readable summary format.

- (_optional_) `<highlight of breaking changes>`
- `<Summary of new features>` (_one or multiple bullets_)
- **Browser module**: New `page.waitForEvent()` for event-based synchronization and `locator.pressSequentially()` for character-by-character typing
- **Better debugging**: Deep object logging in `console.log()` and improved error messages
- **Extensions**: Custom subcommands, DNS resolver access, and URL-based secret management
- **Summary improvements**: Machine-readable summary format with toggle flag
- **Breaking change**: Deprecation of the `experimental/redis` module

## Breaking changes

- `#pr`, `<small_break_1>`
- `#pr`, `<small_break_2>`
- [#5237](https://github.com/grafana/k6/pull/5237) Deprecate the `experimental/redis` module. The module will be removed in a future release; migrate to community extensions or alternative solutions.

### (_optional h3_) `<big_breaking_change>` `#pr`

## New features

_optional intro here_

### `page.waitForEvent()` [#5478](https://github.com/grafana/k6/pull/5478)

The browser module now supports [`page.waitForEvent()`](https://grafana.com/docs/k6/latest/javascript-api/k6-browser/page/waitforevent/), which blocks the caller until a specified event is captured. If a predicate is provided, it waits for an event that satisfies the predicate.

Most browser tests need to wait for specific events before continuing, which is vital for test reliability and avoiding flaky tests.

```javascript
import { browser } from 'k6/browser';

export default async function () {
  const page = await browser.newPage();

  // Wait for a console message containing specific text
  const msgPromise = page.waitForEvent('console', msg => msg.text().includes('hello'));
  await page.evaluate(() => console.log('hello world'));
  const msg = await msgPromise;
  console.log(msg.text());
  // Output: hello world

  // Wait for a response from a specific URL with timeout
  const resPromise = page.waitForEvent('response', {
    predicate: res => res.url().includes('/api/data'),
    timeout: 5000,
  });
  await page.click('button#fetch-data');
  const res = await resPromise;

  await page.close();
}
```

### `locator.pressSequentially()` [#5457](https://github.com/grafana/k6/pull/5457)

The browser module now supports [`locator.pressSequentially()`](https://grafana.com/docs/k6/latest/javascript-api/k6-browser/locator/presssequentially/), which types text character by character, firing keyboard events (`keydown`, `keypress`, `keyup`) for each character. This method is useful for testing features that require gradual typing to trigger specific behaviors, such as autocomplete suggestions, input validation per character, or character counters. Thank you, @rajan2345, for the contribution ðŸŽ‰

The method supports a configurable delay between keystrokes:

```javascript
import { browser } from 'k6/browser';

export const options = {
  scenarios: {
    ui: {
      executor: 'shared-iterations',
      options: {
        browser: {
          type: 'chromium',
        },
      },
    },
  },
};

export default async function () {
  const page = await browser.newPage();

  try {
    await page.goto('https://test.k6.io/browser.php');

    // Type text character by character
    const searchInput = page.locator('#text1');
    await searchInput.pressSequentially('Hello World');

    // Type with delay to simulate realistic typing speed
    await searchInput.clear();
    await searchInput.pressSequentially('test query', { delay: 100 });
  } finally {
    await page.close();
  }
}
```

This complements existing text input methods like [`locator.fill()`](https://grafana.com/docs/k6/latest/javascript-api/k6-browser/locator/fill/) for simple form filling and [`locator.type()`](https://grafana.com/docs/k6/latest/javascript-api/k6-browser/locator/type/) for gradual typing.

### `console.log()` Deep Object Logging [#5460](https://github.com/grafana/k6/pull/5460)

`console.log()` now properly traverses and displays complex JavaScript structures, including functions, classes, and circular references. Previously, nested functions and classes were lost during serialization.

```javascript
// Functions and classes are now properly displayed
console.log({
  handler: class {},
  data: [1, 2, class {}]
});
// Before: {"data":[1,2,null]}
// After:  {"handler":"[object Function]","data":[1,2,"[object Function]"]}
```

Circular references are now properly detected and marked:

```javascript
const obj = { foo: {} };
obj.foo.self = obj;

console.log(obj);
// Before: [object Object]
// After:  {"foo":{"self":"[Circular]"}}
```

This improvement makes debugging k6 test scripts significantly easier when working with complex data structures from API responses or state objects.

### `experimental/websockets` - Close Code and Reason Support [#5376](https://github.com/grafana/k6/pull/5376)

The experimental WebSockets module now supports sending close codes and reasons when closing connections, and properly captures close event information.

```javascript
import ws from 'k6/experimental/websockets';

export default function () {
  const socket = ws.connect('ws://example.com', (socket) => {
    socket.on('close', (data) => {
      console.log(`Connection closed with code: ${data.code}, reason: ${data.reason}`);
      // Output: Connection closed with code: 1000, reason: Normal closure
    });
  });

  // Close with code and reason
  socket.close(1000, 'Normal closure');
}
```

### Extension Capabilities

#### Subcommand Extension Support [#5399](https://github.com/grafana/k6/pull/5399)

Extensions can now register custom subcommands under the `k6 x` namespace, enabling custom command-line tools that integrate seamlessly with k6. This allows extensions to provide specialized CLI utilities while maintaining k6's familiar command structure.

```bash
# Extensions can define custom commands like:
k6 x my-tool --help
k6 x debug --inspect
```

#### DNS Resolver Access [#5421](https://github.com/grafana/k6/pull/5421)

Extensions can now access k6's DNS resolver for custom DNS handling and networking extensions. The resolver respects k6's configuration including `hosts` overrides, custom DNS servers, and DNS caching.

### URL-Based Secret Management [#5413](https://github.com/grafana/k6/pull/5413)

The secret management system now supports URL-based secret sources, allowing k6 to fetch secrets from HTTP endpoints. This enables integration with any HTTP-based secret management service.

```javascript
export const options = {
  secretSource: {
    type: 'url',
    url: 'https://api.example.com/secrets',
    headers: { 'Authorization': 'Bearer token' }
  }
};
```

### Machine-Readable Summary Format [#5338](https://github.com/grafana/k6/pull/5338)

A new machine-readable summary format for the end-of-test summary is now available, providing programmatic shapes via `--summary-export` and `handleSummary()`. This format is currently opt-in via the `--new-machine-readable-summary` flag or `K6_NEW_MACHINE_READABLE_SUMMARY` environment variable, and will become the default in k6 v2.

```bash
k6 run script.js --new-machine-readable-summary --summary-export=summary.json
```

## UX improvements and enhancements

_Format as `<number> <present_verb> <object>. <credit>`_:

- _`#999` Gives terminal output prettier printing. Thanks to `@person` for the help!_
- `#pr` `<description>`
- `#pr` `<description>`
- [#5366](https://github.com/grafana/k6/pull/5366) Adds multi-source secret example for better documentation of secret management patterns.

## Bug fixes

_Format as `<number> <present_verb> <object>. <credit>`_:

- _`#111` Fixes race condition in runtime_
- [#5374](https://github.com/grafana/k6/pull/5374) Fixes `getBy*` selectors when using quotes inside element names.
- [#5477](https://github.com/grafana/k6/pull/5477) Fixes retry mechanism when frame has been detached.
- [#5401](https://github.com/grafana/k6/pull/5401) Fixes panic when assigning to nil headers and cookies when host is not found.
- [#5379](https://github.com/grafana/k6/pull/5379) Fixes browsers not being stopped in tests due to `EndIteration`.
- [#5439](https://github.com/grafana/k6/pull/5439) Fixes loading files with spaces.
- [#5406](https://github.com/grafana/k6/pull/5406) Fixes error messages after Sobek/goja changes.
- [#5381](https://github.com/grafana/k6/pull/5381) Fixes version command JSON output for output extensions.
- [#5358](https://github.com/grafana/k6/pull/5358) Fixes sending correct data when using `ArrayViews` in experimental/websockets.

## Maintenance and internal improvements

_Format as `<number> <present_verb> <object>. <credit>`_:

- _`#2770` Refactors parts of the JS module._
- [#5411](https://github.com/grafana/k6/pull/5411) Extends base config and stops updating go.mod toolchain.
- [#5408](https://github.com/grafana/k6/pull/5408) Removes redundant GitHub Actions rule.
- [#5467](https://github.com/grafana/k6/pull/5467) Refactors span error recording to avoid boilerplate code.
- [#5438](https://github.com/grafana/k6/pull/5438) Unblocks the release workflow for package publishing.
- [#5357](https://github.com/grafana/k6/pull/5357) Refactors browser module task queue usage.
- [#5378](https://github.com/grafana/k6/pull/5378) Fixes `TestNavigationSpanCreation` test in the browser module.
- [#5482](https://github.com/grafana/k6/pull/5482) Fixes tests and subcommand handling in version command.
- [#5436](https://github.com/grafana/k6/pull/5436) Optimizes browser module allocations and improves CI stability.

## _Optional_ Roadmap

_Discussion of future plans_
