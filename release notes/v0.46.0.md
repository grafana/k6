k6 `v0.46` is here üéâ! This release includes:

- (_optional_) `<highlight of breaking changes>`
- `<Summary of new features>` (_one or multiple bullets_)


## Breaking changes

- `#pr`, `<small_break_1>`
- `#pr`, `<small_break_2>`

### (_optional h3_) `<big_breaking_change>` `#pr`

## New features

### Loki log output sending additional headers [#3227](https://github.com/grafana/k6/pull/3227)

k6 has been able to send logs to loki for nearly 3 years since [v0.28.0](https://github.com/grafana/k6/releases/tag/v0.28.0) but didn't support any way to authenticate.

Now it can be configured to send additional headers on every request.

This is being configured with the new `header` config option similar to `label`:

```
k6 --log-output=loki=http://example.org,header.X-My-Header=123,header.Authorization=mytoken ...
```

Will now send the header `X-My-Header` with value `123` and `Authorization` with `mytoken`.

Thanks to @federicotdn for doign the changes

### Cloud Traces [#3100](https://github.com/grafana/k6/pull/3100), [#3202](https://github.com/grafana/k6/pull/3202)

This release supports the new integration between k6 and Tempo in the cloud. Grafana Cloud k6 and Grafana Cloud Traces customers will be able to start their traces in k6 using the existing `k6/experimental/tracing` module to enrich their test run analysis page with metrics and aggregations from tracing data.

The new cloud traces will work "out of the box" for `k6 cloud` runs. In case of `k6 run` execution, the `K6_CLOUD_TRACES_ENABLED` environment variable has to be set to `true`.

### Ability to configure TLS per gRPC connection [#3159](https://github.com/grafana/k6/pull/3159), [xk6-grpc#25](https://github.com/grafana/xk6-grpc/pull/25)

The `k6/net/grpc` and `k6/experimental/grpc` modules now support configuring TLS per-connection via [ConnectParams](https://k6.io/docs/javascript-api/k6-net-grpc/client/client-connect/#connectparams). This is useful when connecting to multiple gRPC servers with different TLS configurations within the same VU.

<details>
<summary> Expand to see an example of the new functionality.</summary>

```javascript
// init phase (1)
const params = {
  "grpcbin.test.notk6.io:9001": {
    plaintext: false,
    tls: {
      cacerts: [open("cacerts0.pem")],
      cert: open("cert0.pem"),
      key: open("key0.pem"),
    }, // password omitted to demonstrate 'optional password'
  },
  "grpcbin.test.fakek6.io:9001": {
    plaintext: false,
    tls: {
      cacerts: open("cacerts1.pem"),
      cert: open("cert1.pem"),
      key: open("key1.pem"),
      password: "cert1-passphrase",
    }, // cacerts as a 'string' to demonstrate string|string[] typing of cacerts
  },
};
const clients = {
  "grpcbin.test.notk6.io:9001": new grpc.Client(),
  "grpcbin.test.fakek6.io:9001": new grpc.Client(),
};
...

// k6 - VU code phase (3)
if (__ITER === 0) {
  clients["grpcbin.test.notk6.io:9001"]
    .connect("grpcbin.test.notk6.io:9001", params["grpcbin.test.notk6.io:9001"]);
  clients["grpcbin.test.notk6.io:9001"]
    .connect("grpcbin.test.fakek6.io:9001", params["grpcbin.test.fakek6.io:9001"]);
}
...
```
</details>

Thanks @chrismoran-mica for contribution üôá‚Äç‚ôÇÔ∏è.

### A better Cloud output [#3117](https://github.com/grafana/k6/issues/3117)

After years of great service we decided to refresh the k6 Cloud output introducing a more efficient end-to-end solution for ingesting the generated tests' metrics.
The new output reduces the load generators' used resources for tests that produce a big amount of metrics. There aren't functional changes, the user experience is expected to be the same as before.
At the moment this is not yet the default Cloud output for the test runs executed from local machines (`k6 run -o cloud`), but it is expected to be transparently enabled in the upcoming weeks.

### `<big_feature_n>` `#pr`

_what, why, and what this means for the user_

### UX improvements and enhancements

_Format as `<number> <present_verb> <object>. <credit>`_:
- _`#999` Gives terminal output prettier printing. Thanks to `@person` for the help!_

- [#3157](https://github.com/grafana/k6/pull/3157) and [#3172](https://github.com/grafana/k6/pull/3172) Add a `MaxTimeSeriesInBatch` configuration option.
- [#3176](https://github.com/grafana/k6/pull/3176) Adds a `js/promises` package, which enables extension developers to easily create promises that will be dispatched to the eventloop using the `New` function.
- [#3181](https://github.com/grafana/k6/pull/3181) Adds a `RunOnEventLoop` method to the `modulestest.Runtime` type, which allows extensions developers to run code on the event loop from their tests.

## Bug fixes

- [#3178](https://github.com/grafana/k6/pull/3178), [xk6-grpc#23](https://github.com/grafana/xk6-grpc/pull/23) Fixes the registration of nested protobuf messages in the gRPC module. Thanks @thiagodpf for reporting and actually fixing the bug!
- [#3194](https://github.com/grafana/k6/pull/3194) Fixes loki log output exiting before push is finished.
- [#3231](https://github.com/grafana/k6/pull/3231) Fixes the tracing module sampling option to default to 1.0 when not set by the user.
- [#3163](https://github.com/grafana/k6/pull/3163) Fixes our gRPC example.
- [#3196](https://github.com/grafana/k6/pull/3196) Logs packages lint fixes, and test for loki flushing at end.

## Maintenance and internal improvements

- [#3170](https://github.com/grafana/pull/3170) Upgraded the version of gRPC k6 demo service dependency for addressing a security vulnerability ([CVE-2023-32731]).
- [#3211](https://github.com/grafana/k6/pull/3211) Updates the experimental gRPC module version used by k6.
- [#3210](https://github.com/grafana/k6/pull/3210) Updates the xk6-output-prometheus-remote version used by k6.
- [#3136](https://github.com/grafana/k6/pull/3136) Updates k6 Go dependencies.
- [#3131](https://github.com/grafana/k6/pull/3131) Updates our Pull Request template to be more structured and include a checklist for contributors.
- [#3177](https://github.com/grafana/k6/pull/3177) Updates the version of golangci-lint we use to the latest version.

### Cloud output v2

// TODO @codebien

* [3104](https://github.com/grafana/k6/pull/3104) Retry and flushers pool
* [3108](https://github.com/grafana/k6/pull/3108) Flush chunks
* [3120](https://github.com/grafana/k6/pull/3120) Unlimited size for body payload
* [3125](https://github.com/grafana/k6/pull/3125) Use a static remote service url
* [3162](https://github.com/grafana/k6/pull/3162) Warn about labels that have reserved names
* [3169](https://github.com/grafana/k6/pull/3169) Compact histogram
- [#3182](https://github.com/grafana/k6/pull/3182) Fix off-by-one error for spans
- [#3186](https://github.com/grafana/k6/pull/3186) Be less noisy when handling errors
- [#3187](https://github.com/grafana/k6/pull/3187) Create batches for single bucket flush
- [#3193](https://github.com/grafana/k6/pull/3193) Downscale the batch size
- [#3195](https://github.com/grafana/k6/pull/3195) Make sure to use the overwritten config
- [#3206](https://github.com/grafana/k6/pull/3206) Implement concurrent pushes accross batches
- [#3226](https://github.com/grafana/k6/pull/3226) don't go over maxSeriesInBatch

## _Optional_ Roadmap

_Discussion of future plans_
