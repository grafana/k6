name: Build
on:
  workflow_dispatch:
    inputs:
      k6_version:
        description: 'The version of the release, it must use the semantic versioning format with the v prefix. It is a development release so it is suggested to append a build metadata (e.g. v0.38.0-dev).'
        required: true
      go_version:
        description: 'Go version for building binaries'
        default: '1.x'
        required: true
  push:
    branches:
      - master
    tags:
      - v*
  pull_request:

defaults:
  run:
    shell: bash

permissions:
  contents: read

env:
  APP_NAME: "k6"
  DOCKER_IMAGE_ID: "grafana/k6"
  GHCR_IMAGE_ID: ${{ github.repository }}
  DEFAULT_GO_VERSION: "1.25.x"

jobs:
  configure:
    runs-on: ubuntu-latest
    outputs:
      k6_version: ${{ steps.get_k6_version.outputs.k6_version }}
      go_version: ${{ steps.get_go_version.outputs.go_version }}
      sign_windows_artifacts: ${{ steps.determine_windows_signing.outputs.sign_windows_artifacts }}
    steps:
      - name: Checkout code
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5
        with:
          fetch-depth: 0
          persist-credentials: false
      - name: Get the k6 version
        id: get_k6_version
        env:
          INPUT_K6_VERSION: ${{ github.event.inputs.k6_version  }}
        run: |
          set -x # Show exactly what commands are executed
          if [[ "${GITHUB_EVENT_NAME}" == "workflow_dispatch" ]] && [[ "${INPUT_K6_VERSION}" != "" ]]; then
            VERSION="${INPUT_K6_VERSION}"
            echo "Building custom dev build with version '${VERSION}' from manual workflow_dispatch..."
          elif [[ "${GITHUB_REF}" =~ ^refs/tags/v.+$ ]]; then
            VERSION="${GITHUB_REF##*/}"
            echo "Building real version tag '${GITHUB_REF}', parsed '${VERSION}' as the actual version..."
          else
            VERSION="$(git describe --tags --always --long --dirty)"
            echo "Building a non-version ref '${GITHUB_REF}', use '${VERSION}' as the version instead..."
          fi
          echo "VERSION=${VERSION}"
          echo "k6_version=${VERSION}" >> $GITHUB_OUTPUT
      - name: Get the used Go version
        id: get_go_version
        env:
          INPUT_GO_VERSION: ${{ github.event.inputs.go_version  }}
        run: |
          set -x # Show exactly what commands are executed
          if [[ "${GITHUB_EVENT_NAME}" == "workflow_dispatch" ]] && [[ "${INPUT_GO_VERSION}" != "" ]]; then
            GO_VERSION="${INPUT_GO_VERSION}"
            echo "Using custom Go version '${GO_VERSION}' from manual workflow_dispatch..."
          else
            GO_VERSION="${DEFAULT_GO_VERSION}"
            echo "Using the default Go version '${GO_VERSION}'..."
          fi
          echo "GO_VERSION=${GO_VERSION}"
          echo "go_version=${GO_VERSION}" >> $GITHUB_OUTPUT
      - name: Print version and exit
        env:
            VERSION: ${{ steps.get_k6_version.outputs.k6_version }}
            GO_VERSION: ${{ steps.get_go_version.outputs.go_version }}
            GITHUB_REF: ${{ github.ref }}
            EVENT_NAME: ${{ github.event_name }}
        run: |
            echo "========================================="
            echo "ğŸ” TESTING MODE - Build workflow disabled"
            echo "========================================="
            echo ""
            echo "ğŸ“¦ Version from tag: ${VERSION}"
            echo "ğŸ”§ Go version: ${GO_VERSION}"
            echo "ğŸ“ GitHub ref: ${GITHUB_REF}"
            echo "ğŸ¯ Event: ${EVENT_NAME}"
            echo ""
            echo "========================================="
            echo "âœ… Version detection successful!"
            echo "ğŸš« Actual build/release disabled for testing"
            echo "========================================="
            exit 0

  # TEMPORARY: All jobs below removed for testing
  # Restore them when ready to do actual releases
